<?php

namespace App\Http\Controllers;

use App\Models\Appointment;
use App\Models\User;
use App\Models\Notification;
use App\Models\Doctor;
use App\Models\Hospital;
use App\Models\Schedule;
use App\Models\Patient;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;

class AppointmentController extends Controller
{
    public function index()
    {
        return response()->json(Appointment::with(['patient', 'hospital', 'doctor', 'schedule'])->get());
    }

    public function store(Request $request)
{
    $validatedData = $request->validate([
        'doctor_name' => 'required|string',
        'hospital_name' => 'required|string',
        'day_of_week' => 'required|string',
        'start_time' => 'required|date_format:H:i',
        'end_time' => 'required|date_format:H:i',
    ]);

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨
    $doctor = Doctor::whereRaw('LOWER(doctor_name) = ?', [strtolower($validatedData['doctor_name'])])->first();
    if (!$doctor) {
        return response()->json(['error' => 'Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'], 404);
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
    $hospital = Hospital::whereRaw('LOWER(hospital_name) = ?', [strtolower($validatedData['hospital_name'])])->first();
    if (!$hospital) {
        return response()->json(['error' => 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'], 404);
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ÙˆÙ‚Øª
    $schedule = Schedule::where('doctor_id', $doctor->doctor_id)
                        ->where('hospital_id', $hospital->hospital_id)
                        ->where('day_of_week', $validatedData['day_of_week'])
                        ->where('start_time', $validatedData['start_time'])
                        ->where('end_time', $validatedData['end_time'])
                        ->first();

    if (!$schedule) {
        return response()->json(['error' => 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¹Ø¯ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ÙˆÙ‚Øª.'], 404);
    }

    // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù„Ù„Ù…Ø±ÙŠØ¶
    $appointment = new Appointment();
    $appointment->doctor_id = $doctor->doctor_id;
    $appointment->hospital_id = $hospital->hospital_id;
    $appointment->patient_id = $request->patient_id; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† patient_id Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ request
    $appointment->schedule_id = $schedule->schedule_id; // Ø±Ø¨Ø· Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù€ schedule_id
    $appointment->status = 'Pending'; // Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
    $appointment->save();

    return response()->json([
        'message' => 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­.',
        'data' => $appointment
    ], 201);
}



    public function approveAppointment($appointmentId)
    {
        $appointment = Appointment::find($appointmentId);
    
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù‚Ø¯ ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²
        if ($appointment && $appointment->hospital_approval == 'approved') {
            $appointment->status = 'confirmed';
            $appointment->save();
    
            return response()->json(['success' => 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø².'], 200);
        }
    
        return response()->json(['error' => 'Ø§Ù„Ø­Ø¬Ø² Ù„Ù… ØªØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰.'], 400);
    }
    





















public function respondToAppointment(Request $request, $id)
{
    $request->validate([
        'action' => 'required|in:accept,reject',
    ]);

    $appointment = Appointment::with(['patient', 'doctor'])->findOrFail($id);

    if ($request->action === 'accept') {
        $appointment->status = 'Confirmed';
        $appointment->save();

        // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø±ÙŠØ¶
        Notification::create([
            'user_id' => $appointment->patient->user_id,
            'created_by' => auth()->id(),
            'title' => 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²',
            'message' => 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø¨Ù†Ø¬Ø§Ø­.',
            'type' => 'booking',
            'is_read' => 0,
        ]);

        // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ø¨ÙŠØ¨
        $doctorUser = User::where('doctor_id', $appointment->doctor_id)->first();
        if ($doctorUser) {
            Notification::create([
                'user_id' => $doctorUser->user_id,
                'created_by' => auth()->id(),
                'title' => 'Ù„Ø¯ÙŠÙƒ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯',
                'message' => 'ÙŠÙˆØ¬Ø¯ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø±ÙŠØ¶ ' . $appointment->patient->patient_name,
                'type' => 'booking',
                'is_read' => 0,
            ]);
        }

    } else {
        $appointment->status = 'Rejected';
        $appointment->save();

        // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø±ÙŠØ¶ Ø¨Ø§Ù„Ø±ÙØ¶
        Notification::create([
            'user_id' => $appointment->patient->user_id,
            'created_by' => auth()->id(),
            'title' => 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­Ø¬Ø²',
            'message' => 'Ù†Ø£Ø³ÙØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.',
            'type' => 'Rejected',
            'is_read' => 0,
        ]);
    }

    return response()->json(['message' => 'ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­.']);
}















    public function reviewAppointment(Request $request, $id)
    {
        Log::info('ðŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø¬Ø² Ø¨Ø§Ù„Ù…Ø¹Ø±Ù:', ['appointment_id' => $id]);
    
        $appointment = Appointment::where('appointment_id', $id)->first();
        if (!$appointment) {
            Log::error('âŒ Ø§Ù„Ø­Ø¬Ø² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!', ['appointment_id' => $id]);
            return response()->json(['message' => 'Ø§Ù„Ø­Ø¬Ø² ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'], 404);
        }
    
        Log::info('âœ… Ø§Ù„Ø­Ø¬Ø² Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
    
        $request->validate([
            'status' => 'in:Confirmed,Rejected,Cancelled',
        ]);
    
        $appointment->update(['status' => $request->status]);
    
        Log::info('ðŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø±Ø¶Ù‰ ÙˆØ§Ù„Ø£Ø·Ø¨Ø§Ø¡...');
    
        if ($request->status == 'Confirmed') {
            $patientUserId = DB::table('users')->where('patient_id', $appointment->patient_id)->value('user_id');
            $doctorUserId = DB::table('users')->where('doctor_id', $appointment->doctor_id)->value('user_id');
    
            $patient = DB::table('patients')->where('patient_id', $appointment->patient_id)->first();
            $hospital = DB::table('hospitals')->where('hospital_id', $appointment->hospital_id)->first();
            $schedule = DB::table('doctor_schedules')->where('schedule_id', $appointment->schedule_id)->first();
    
            if ($patient && $hospital && $schedule) {
                $startTime = Carbon::parse($schedule->start_time)->format('h:i A');
                $endTime = Carbon::parse($schedule->end_time)->format('h:i A');
    
                $patientName = $patient->patient_name ?? "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                $hospitalName = $hospital->hospital_name ?? "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    
                $patientMessage = "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø­Ø¬Ø²Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ $hospitalName Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨.";
                $doctorMessage = "Ù„Ø¯ÙŠÙƒ Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ $patientName ÙÙŠ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ $hospitalName Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© $startTime Ø¥Ù„Ù‰ $endTime.";
    
                $this->sendNotification($patientUserId, 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ', $patientMessage);
                $this->sendNotification($doctorUserId, 'Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯', $doctorMessage);
            }
    
            // âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª (schedule_id)
            $confirmedAppointmentsCount = Appointment::where('schedule_id', $appointment->schedule_id)
                ->where('status', 'Confirmed')
                ->count();
    
            if ($confirmedAppointmentsCount >= 15) {
                // Ø¥Ø°Ø§ ÙˆØµÙ„ Ø§Ù„Ø¹Ø¯Ø¯ Ø¥Ù„Ù‰ 15ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ "Completed"
                Appointment::where('schedule_id', $appointment->schedule_id)
                    ->where('status', 'Confirmed')
                    ->update(['status' => 'Completed']);
    
                Log::info("ðŸš¨ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ø¬Ø² Ù„Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø¹Ø¯ 15 Ø­Ø¬Ø².", ['schedule_id' => $appointment->schedule_id]);
            }
        }
    
        return response()->json(['message' => 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­'], 200);
    }
    
public function sendNotification($userId, $title, $message)
{
    Log::info('ðŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±...', [
        'user_id' => $userId,
        'title' => $title,
        'message' => $message
    ]);

    $user = User::find($userId);
    if (!$user) {
        Log::error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!', ['user_id' => $userId]);
        return;
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠ
    Notification::create([
        'user_id' => $user->user_id,
        'title' => $title,
        'message' => $message,
        'status' => 'unread',
    ]);

    Log::info('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!');
}
public function getAppointmentsForDoctor()
{
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ
    $user = Auth::user();
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø·Ø¨ÙŠØ¨
    $userType = DB::table('users')->where('user_id', $user->user_id)->value('user_type');
    if ($userType !== 'doctor') {
        return response()->json(['message' => 'Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· Ù„Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª'], 403);
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ø¨ÙŠØ¨
    $appointments = Appointment::with(['patient', 'hospital', 'schedule'])
                               ->where('doctor_id', $user->doctor_id)
                               ->get();
    
    return response()->json($appointments);
}
public function getAppointmentsForHospital()
{
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ
    $user = Auth::user();
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ù…Ø³ØªØ´ÙÙ‰
    $userType = DB::table('users')->where('user_id', $user->user_id)->value('user_type');
    if ($userType !== 'hospital') {
        return response()->json(['message' => 'Ù…Ø³Ù…ÙˆØ­ ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª'], 403);
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
    $appointments = Appointment::with(['patient', 'doctor', 'schedule'])
                               ->where('hospital_id', $user->hospital_id)
                               ->get();
    
    return response()->json($appointments);
}



    }

